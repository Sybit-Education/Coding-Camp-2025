<app-go-back-button class="mb-4 flex px-6"></app-go-back-button>
<div class="flex px-6">
  <span class="ml-2 text-left text-2xl font-bold text-gray-800">
    {{ isEditMode() ? ('create-event.title-edit' | translate) : ('create-event.title-create' | translate) }}
  </span>
</div>
<div class="flex flex-col items-center justify-center rounded-2xl p-5">
  <form class="rounded-2xl bg-white p-6 shadow-2xl" (ngSubmit)="saveEvent()" autocomplete="on">
    <!-- Event Name -->
    <div>
      <label for="eventName" class="required">{{ 'create-event.eventname' | translate }}</label>
      <input
        #eventNameInput
        id="eventName"
        name="eventName"
        type="text"
        [(ngModel)]="eventName"
        class="w-full"
        [class]="this.errorName ? 'error' : ''"
        [attr.aria-invalid]="this.errorName ? true : null"
        [attr.aria-describedby]="this.errorName ? 'eventName-error' : null"
        required="true"
      />
      @if (this.errorName) {
        <p id="eventName-error" role="alert" class="error mt-2 text-sm">
          {{ 'create-event.error.name' | translate }}
        </p>
      }
    </div>

    <!-- Datum und Zeit -->
    <div class="flex grid flex-col gap-[3rem] sm:grid-cols-[1fr] md:w-full md:grid-cols-[1fr_1fr]">
      <div class="grid grid-cols-2 gap-[1rem]">
        <div class="my-4">
          <label for="date" class="required">{{ 'create-event.startdate' | translate }}</label>
          <input
            #dateStartInput
            id="date"
            type="date"
            [(ngModel)]="dateStart"
            name="dateStart"
            class="w-full"
            [class]="this.errorDate ? 'error' : ''"
            [attr.aria-invalid]="this.errorDate ? true : null"
            [attr.aria-describedby]="this.errorDate ? 'dateStart-error' : null"
            required="true"
          />
          @if (this.errorDate) {
            <p id="dateStart-error" role="alert" class="mt-2 text-sm text-red-600 dark:text-red-500">
              {{ 'create-event.error.date' | translate }}
            </p>
          }
          <!-- Zeitspanne -->
          <div class="mx-2 my-2">
            <input id="timePeriode" name="timePeriode" type="checkbox" [(ngModel)]="timePeriode" class="cursor-pointer" />
            <label for="timePeriode" class="ms-2 w-full cursor-pointer">
              {{ 'create-event.timespan' | translate }}
            </label>
          </div>
        </div>
        <!-- Startzeit -->
        <div class="my-4">
          <label for="time" class="required">{{ 'create-event.starttime' | translate }}</label>
          <input
            #timeStartInput
            id="time"
            type="time"
            [(ngModel)]="timeStart"
            name="timeStart"
            class="w-full"
            [class]="this.errorTime ? 'error' : ''"
            [attr.aria-invalid]="this.errorTime ? true : null"
            [attr.aria-describedby]="this.errorTime ? 'timeStart-error' : null"
            required="true"
          />
          @if (this.errorTime) {
            <p id="timeStart-error" role="alert" class="mt-2 text-sm text-red-600 dark:text-red-500">
              {{ 'create-event.error.time' | translate }}
            </p>
          }
        </div>
      </div>

      @if (timePeriode) {
        <div class="grid grid-cols-2 gap-[1rem]">
          <div class="my-4">
            <label for="dateEnd">{{ 'create-event.enddate' | translate }}</label>
            <input id="dateEnd" type="date" [(ngModel)]="dateEnd" name="dateEnd" class="w-full" />
          </div>
          <div class="my-4">
            <label for="timeEnd">{{ 'create-event.endtime' | translate }}</label>
            <input id="timeEnd" type="time" [(ngModel)]="timeEnd" name="timeEnd" class="w-full" />
          </div>
        </div>
      }
    </div>

    <div class="flex grid flex-col gap-[3rem] sm:grid-cols-[1fr] md:w-full md:grid-cols-[1fr_1fr]">
      <!-- Location Auswahl -->
      <div>
        <app-location-input
          [locations]="locations"
          [selectedLocation]="selectedLocation"
          [errorLocation]="errorLocation"
          (locationSelected)="setLocation($event)"
        ></app-location-input>
      </div>

      <!-- Veranstalter Auswahl -->
      <app-organizer-input
        [organizers]="organizers"
        [selectedOrganizer]="selectedOrganizer"
        (organizerSelected)="setOrganizer($event)"
      ></app-organizer-input>
    </div>

    <!-- Beschreibung -->
    <div class="my-4">
      <label for="description">{{ 'create-event.description' | translate }}</label>
      <quill-editor
        name="description"
        [maxLength]="5000"
        [styles]="{ minHeight: '250px' }"
        [(ngModel)]="description"
        [placeholder]="'create-event.descriptionPlaceholder' | translate"
        [format]="'html'"
        [modules]="{
          toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], ['link']],
          clipboard: {
            matchVisual: false,
          },
        }"
        theme="snow"
        class="w-full rounded-md border"
      >
      </quill-editor>
    </div>

    <div class="flex grid flex-col gap-[3rem] sm:grid-cols-[1fr] md:w-full md:grid-cols-[1fr_1fr]">
      <div class="flex flex-col">
        <!-- Themen -->
        <h3>
          {{ 'create-event.topics' | translate }}
        </h3>
        <!-- Event-Typ -->
        <div>
          <label for="eventType" class="required">{{ 'create-event.eventtype' | translate }}</label>
          <select
            id="eventType"
            name="eventType"
            [(ngModel)]="selectedEventType"
            (ngModelChange)="setSelectedEventType($event)"
            class="border-Gray-600 w-full cursor-pointer rounded-[6px] border-2"
            [class]="this.errorTheme ? 'error' : ''"
            [attr.aria-invalid]="this.errorTheme ? true : null"
            [attr.aria-describedby]="this.errorTheme ? 'eventType-error' : null"
          >
            <option [ngValue]="null">
              {{ 'create-event.topics' | translate }}
            </option>
            @for (eventType of eventTypes; track eventType) {
              <option [ngValue]="eventType">
                {{ eventType.name }}
              </option>
            }
          </select>
        </div>

        @if (errorTheme) {
          <p id="eventType-error" role="alert" class="mt-2 text-sm text-red-600 dark:text-red-500">
            {{ 'create-event.error.theme' | translate }}
          </p>
        }
        <div id="choose-category" class="my-4 rounded-lg bg-white shadow-sm dark:bg-gray-100">
          <ul class="mb-0 list-none p-3 text-gray-700 dark:text-gray-200">
            @for (topic of topics; track topic) {
              <li>
                <div>
                  <input
                    id="checkbox{{ topic.id }}"
                    name="topicCheckbox{{ topic.id }}"
                    type="checkbox"
                    [value]="topic.id"
                    [checked]="selectedTopics.includes(topic)"
                    (change)="toggleTopicSelection($event, topic)"
                    class="h-4 w-4 cursor-pointer"
                  />

                  <label for="checkbox{{ topic.id }}" class="ms-2 w-full cursor-pointer text-gray-900 dark:text-gray-700">
                    {{ topic.name }}
                  </label>
                  @if (accessibility && topicService.isTopicAccessibility(topic)) {
                    <div>
                      @for (accessibility of allAccessebiltiys; track accessibility) {
                        <div class="ml-6">
                          <input
                            id="accessibilityCheckbox{{ accessibility.accessibilityName }}"
                            name="accessibilitysCheckbox{{ accessibility.accessibilityName }}"
                            type="checkbox"
                            [value]="accessibility.accessibilityName"
                            [checked]="selectedAccessibiltiys.includes(accessibility)"
                            (change)="toggleAccessibilitySelection($event, accessibility)"
                            class="h-4 w-4 cursor-pointer"
                          />
                          <label
                            for="accessibilityCheckbox{{ accessibility.accessibilityName }}"
                            class="ms-2 w-full cursor-pointer text-gray-900 dark:text-gray-700"
                          >
                            {{ accessibility.accessibilityName }}
                          </label>
                        </div>
                      }
                    </div>
                  }
                </div>
              </li>
            }
          </ul>
        </div>
      </div>
      <div>
        <!-- Mehr Infos -->
        <div class="my-4 mt-6">
          <label for="moreInfoLink">{{ 'create-event.moreinfo' | translate }}</label>
          <input
            id="moreInfoLink"
            name="moreInfoLink"
            type="url"
            placeholder="{{ 'create-event.moreinfoexample' | translate }}"
            [(ngModel)]="moreInfosLink"
            class="w-full"
          />
        </div>

        <!-- Einschränkungen -->
        <div class="my-4">
          <label for="restriction">{{ 'create-event.restrictions' | translate }}</label>
          <input
            id="restriction"
            name="restriction"
            type="text"
            [(ngModel)]="restriction"
            class="w-full"
            placeholder="{{ 'create-event.restrictionsexample' | translate }}"
          />
        </div>
        <!-- Preis -->
        <div class="my-4">
          <label for="price">{{ 'create-event.price' | translate }}</label>
          <input
            id="price"
            name="price"
            type="number"
            min="0"
            step="0.01"
            placeholder="0.00"
            [(ngModel)]="price"
            class="w-full"
          />
        </div>
      </div>
    </div>

    <div>
      <!-- Bild-Upload -->
      <app-image-upload [eventName]="eventName" [existingImages]="images"> </app-image-upload>

      <!-- Button: Event erstellen -->
      @if (this.errorDate || this.errorName || this.errorTime) {
        <div>
          <p role="alert" class="mt-2 text-sm text-red-600 dark:text-red-500">
            {{ 'create-event.error.general' | translate }}
          </p>
        </div>
      }
    </div>
    <div class="my-8 flex grid w-full flex-col gap-[3rem] sm:grid-cols-[1fr] md:grid-cols-[1fr_1fr] lg:grid-cols-[1fr_1fr_1fr]">
	      <button
	        type="submit"
	        class="w-full cursor-pointer rounded-2xl bg-blue-600 p-5 text-white hover:bg-blue-700"
	      >
        {{ (eventId ? 'create-event.updateevent' : 'create-event.createevent') | translate }}
      </button>

      <button
        type="button"
        class="w-full cursor-pointer rounded-2xl bg-gray-300 p-5 text-gray-800 hover:bg-gray-400"
        (click)="cancelEvent()"
      >
        {{ 'create-event.cancel' | translate }}
      </button>

      <!-- Löschen-Button (nur bei bestehenden Events anzeigen) -->
      @if (eventId) {
        <button
          type="button"
          class="w-full cursor-pointer rounded-2xl bg-red-500 p-5 text-white hover:bg-red-600"
          (click)="openDeleteDialog()"
          [attr.aria-label]="('create-event.delete' | translate)"
        >
          {{ 'create-event.delete' | translate }}
        </button>
      }
    </div>
  </form>
  @if (isSaving) {
    <div class="absolute inset-0 flex items-center justify-center bg-gray-200/60">
      <app-loading-spinner />
    </div>
  }

  <app-confirm-dialog
    [opened]="deleteDialogOpen()"
    (openedChange)="deleteDialogOpen.set($event)"
    [title]="deleteDialogTitle()"
    [message]="deleteDialogMessage()"
    [confirmLabel]="deleteConfirmLabel()"
    [cancelLabel]="deleteCancelLabel()"
    (confirmed)="confirmDeleteEvent()"
    (cancelled)="cancelDeleteDialog()"
  />
</div>
