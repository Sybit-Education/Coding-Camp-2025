<div class="relative mb-4 w-full" [ngClass]="dropdownOpen() ? 'h-10' : ''">
  <!-- Dropdown-Feld -->
  <button
    type="button"
    class="flex w-full cursor-pointer flex-wrap items-center gap-1 border-1 border-gray-400 bg-white px-3 py-2"
    [class.rounded-t-2xl]="dropdownOpen()"
    [class.rounded-2xl]="!dropdownOpen()"
    [class.flex-row]="selectedItems().length === 0"
    [class.flex-col]="selectedItems().length > 0"
    (click)="toggleDropdown()"
    (keydown.enter)="toggleDropdown()"
    (keydown.space)="toggleDropdown(); $event.preventDefault()"
    tabindex="0"
    aria-haspopup="listbox"
    [attr.aria-expanded]="dropdownOpen()"
    [attr.aria-controls]="listboxId"
    [id]="buttonId"
  >
    <app-search
      (searchTermChange)="onSearchChange($event)"
      [searchTerm]="searchTerm()"
      [class.w-full]="selectedItems().length > 0"
      [class.flex-grow]="selectedItems().length === 0"
      (click)="$event.stopPropagation()"
      (keydown.enter)="$event.stopPropagation()"
      class="min-w-0"
    />
    <!-- Chips / Placeholder -->
    @if (selectedItems().length > 0) {
      <div class="flex min-w-0 flex-wrap gap-1">
        @for (item of selectedItems(); track item.id) {
          <span class="flex items-center gap-1 rounded bg-gray-200 px-2 py-0.5">
            {{ item.name }}
            <button
              type="button"
              (click)="removeItem(item); $event.stopPropagation()"
              (keydown.enter)="removeItem(item); $event.stopPropagation()"
              [attr.aria-label]="'custom-dropdown.remove' | translate: { name: item.name }"
              class="ml-2 flex cursor-pointer items-center justify-center"
            >
              <app-icon name="close" class="h-6 w-6" aria-hidden="true" />
            </button>
          </span>
        }
      </div>
    }

    <!-- Pfeil -->
    <svg class="ml-auto h-4 w-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <!-- Dropdown-Liste -->
  @if (dropdownOpen()) {
    <div
      class="absolute right-0 left-0 z-50 mt-0 max-h-40 overflow-x-hidden overflow-y-auto rounded-b-2xl border-1 border-gray-400 bg-white"
      tabindex="-1"
      role="listbox"
      [id]="listboxId"
      [attr.aria-label]="'custom-dropdown.options' | translate"
      aria-multiselectable="true"
      (keydown.escape)="closeDropdown()"
    >
      <ul>
        @for (item of filteredItems(); track item.id) {
          <li
            class="flex max-w-[340px] cursor-pointer items-center justify-between px-3 hover:bg-gray-100"
            (click)="addItem(item)"
            (keydown.enter)="addItem(item)"
            (keydown.space)="addItem(item); $event.preventDefault()"
            (keydown.arrowDown)="focusNextOption($event)"
            (keydown.arrowUp)="focusPrevOption($event)"
            tabindex="0"
            role="option"
            [attr.aria-selected]="isSelected(item)"
          >
            <p class="break-normal">{{ item.name }}</p>
          </li>
        }
      </ul>
    </div>
  }
</div>
